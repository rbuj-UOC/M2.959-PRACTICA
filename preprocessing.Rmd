---
title: Anàlisi de Dades
author: "Robert Buj"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    warning = FALSE, error = FALSE, message = FALSE,
    # cache = TRUE, # Activa la memòria cau
    # cache.lazy = FALSE, # Desactiva la càrrega diferida de la memòria cau
    # Opcions per a les figures
    fig.align = "center"
)
# carrega les biblioteques necessàries
suppressPackageStartupMessages({
    library(dplyr)
    library(ggplot2)
    library(data.table)
})
```

```{r}
# Entra en la carpeta dataset i executa l'script per fusionar els fitxers de
# recollida selectiva
setwd("dataset")
system("bash t6997com.sh")
setwd("..")
```

```{r load-data}
# Carrega el dataset
recollida_ds <- fread(
    "dataset/t6997com.csv",
    sep = ";", # Separador de columnes
    dec = ",", # Separador decimal
    data.table = FALSE # Retorna data.frame per compatibilitat
)
# canvia el nom de la Comarca "Aran" a "Vall d'Aran"
recollida_ds <- recollida_ds |>
    mutate(Nom = ifelse(Nom == "Aran" | Nom == "Val d'Aran", "Vall d'Aran", Nom))
# canvia el nom de la columna `Nom` a `Comarca`
colnames(recollida_ds)[colnames(recollida_ds) == "Nom"] <- "Comarca"
# Elimina la columna `Codi` i la columna `Total`
recollida_ds <- recollida_ds |> select(-Codi, -Total)
# Resum estadistic del dataset
summary(recollida_ds)
```

Carrega el fitxer amb les divisions administratives de Catalunya:

```{r, read-boundaries}
# Carrega el dataset de les divisions administratives
boundaries_ds <- fread(
    "dataset/divisions-administratives-v2r1-caps-municipi-20250730.csv",
    sep = ";", # Separador de columnes
    dec = ".", # Separador decimal
    data.table = FALSE # Retorna data.frame per compatibilitat
)
# canvia el nom de la comarca "Val d'Aran" a "Vall d'Aran"
boundaries_ds <- boundaries_ds |>
    mutate(Comarca = ifelse(Comarca == "Val d'Aran" | Comarca == "Aran", "Vall d'Aran", Comarca))
# Selecciona les columnes rellevants i elimina les files duplicades
cols <- c("Comarca", "Província", "Longitud", "Latitud")
boundaries_ds <- boundaries_ds |>
    select(all_of(cols)) |>
    group_by(`Comarca`) |>
    slice(1) |>
    ungroup()
boundaries_ds <- boundaries_ds |> distinct()
# Resum estadistic del dataset
summary(boundaries_ds)
```

Fusionar amb el dataset dels residus de les comarques amb les divisions
administratives:

```{r}
merged_ds <- recollida_ds |>
    left_join(boundaries_ds, by = c("Comarca" = "Comarca")) |>
    # Reordena les columnes
    select(Any, Comarca, Província, Longitud, Latitud, everything())
# Resum estadistic del dataset fusionat
summary(merged_ds)
```

```{r}
# Entra en la carpeta dataset i executa l'script per fusionar els fitxers de
# densitat de població
setwd("dataset")
system("bash t15227.sh")
setwd("..")
```

Carrega el dataset amb la Superfície km2 de població per comarca:

```{r, read-area}
# Carrega el dataset de densitat de població
area_ds <- fread(
    "dataset/t15227.csv",
    sep = ";", # Separador de columnes
    dec = ",", # Separador decimal
    na.strings = c("", ".."), # Valors que representen NA
    data.table = FALSE # Retorna data.frame per compatibilitat
)
# canvia el nom de la comarca "Val d'Aran" a "Vall d'Aran"
area_ds <- area_ds |>
    mutate(Comarca = ifelse(Comarca == "Val d'Aran" | Comarca == "Aran", "Vall d'Aran", Comarca)) |>
    # Selecciona les columnes rellevants
    select(Any, Comarca, `Superfície km2`) |>
    group_by(Comarca, Any) |>
    slice(1) |>
    ungroup()
# resum estadistic del dataset
summary(area_ds)
```

Fusionar el dataset dels residus amb el de densitat de població:

```{r}
final_ds <- merged_ds |>
    left_join(area_ds, by = c("Comarca" = "Comarca", "Any" = "Any")) |>
    filter(Any >= 2006 & Any <= 2022) |>
    # Reordena les columnes
    select(
        Any, Comarca, Província, Longitud, Latitud, `Superfície km2`,
        everything()
    ) |>
    arrange(Any, Comarca)
# Resum estadistic del dataset final
summary(final_ds)
```


```{r}
# Entra a la carpeta dataset i executa l'script per fusionar els fitxers de
# densitat de població
setwd("dataset")
system("bash t15233.sh")
setwd("..")
```

Carrega el fitxer de densitat de població femenina per comarca:

```{r, read-density-female}
# Carrega el dataset de densitat de població
density_ds <- fread(
    "dataset/t15233-D.csv",
    sep = ";", # Separador de columnes
    dec = ",", # Separador decimal
    na.strings = c("", ".."), # Valors que representen NA
    data.table = FALSE # Retorna data.frame per compatibilitat
)
# canvia el nom de la comarca "Val d'Aran" a "Vall d'Aran" i elimina la columna `Dona Sum`
density_ds <- density_ds |>
    mutate(Comarca = ifelse(Comarca == "Val d'Aran" | Comarca == "Aran", "Vall d'Aran", Comarca)) |>
    select(-`Dona Sum`)
# resum estadistic del dataset
summary(density_ds)
# Files que tenen NA a la columna Població
density_ds[is.na(density_ds$Població), ]
# Fusiona la densitat de població al dataset final
final_ds <- final_ds |>
    left_join(
        density_ds,
        by = c("Comarca" = "Comarca", "Any" = "Any")
    )
# Resum estadistic del dataset final
summary(final_ds)
```

Carrega el fitxer de densitat de població masculina per comarca:

```{r, read-density-male}
# Carrega el dataset de densitat de població
density_ds <- fread(
    "dataset/t15233-H.csv",
    sep = ";", # Separador de columnes
    dec = ",", # Separador decimal
    na.strings = c("", ".."), # Valors que representen NA
    data.table = FALSE # Retorna data.frame per compatibilitat
)
# canvia el nom de la comarca "Val d'Aran" a "Vall d'Aran" i elimina la columna `Home Sum`
density_ds <- density_ds |>
    mutate(Comarca = ifelse(Comarca == "Val d'Aran" | Comarca == "Aran", "Vall d'Aran", Comarca)) |>
    select(-`Home Sum`)
# resum estadistic del dataset
summary(density_ds)
# Files que tenen NA a la columna Població
density_ds[is.na(density_ds$Població), ]
# Fusiona la densitat de població al dataset final
final_ds <- final_ds |>
    left_join(
        density_ds,
        by = c("Comarca" = "Comarca", "Any" = "Any")
    )
# Resum estadistic del dataset final
summary(final_ds)
```

```{r}
# Canvia el nom de les columnes de densitat de població
colnames(final_ds)[colnames(final_ds) == "Dona 0-15"] <- "Població.x 0-15"
colnames(final_ds)[colnames(final_ds) == "Dona 16-24"] <- "Població.x 16-24"
colnames(final_ds)[colnames(final_ds) == "Dona 25-44"] <- "Població.x 25-44"
colnames(final_ds)[colnames(final_ds) == "Dona 45-64"] <- "Població.x 45-64"
colnames(final_ds)[colnames(final_ds) == "Dona 65 i més"] <- "Població.x 64+"

colnames(final_ds)[colnames(final_ds) == "Home 0-15"] <- "Població.y 0-15"
colnames(final_ds)[colnames(final_ds) == "Home 16-24"] <- "Població.y 16-24"
colnames(final_ds)[colnames(final_ds) == "Home 25-44"] <- "Població.y 25-44"
colnames(final_ds)[colnames(final_ds) == "Home 45-64"] <- "Població.y 45-64"
colnames(final_ds)[colnames(final_ds) == "Home 65 i més"] <- "Població.y 64+"

# Ordena les columnes del dataset final
final_ds <- final_ds |>
    select(
        Any, Comarca, Província, Longitud, Latitud, `Superfície km2`,
        `Població.x 0-15`, `Població.y 0-15`,
        `Població.x 16-24`, `Població.y 16-24`,
        `Població.x 25-44`, `Població.y 25-44`,
        `Població.x 45-64`, `Població.y 45-64`,
        `Població.x 64+`, `Població.y 64+`,
        everything()
    )
```

Desa el dataset final en format CSV:

```{r, save-final-ds}
fwrite(
    final_ds |>
        arrange(Any, Comarca) |>
        select(
            Any, Comarca, Província, Longitud, Latitud, `Superfície km2`,
            everything()
        ),
    "data/recollida-selectiva-comarques-2006-2021.csv",
    sep = ",",
    dec = ".",
    verbose = FALSE
)
# Elimina els fitxer temporals
file.remove("dataset/t6997com.csv")
file.remove("dataset/t15227.csv")
file.remove("dataset/t15233-D.csv")
file.remove("dataset/t15233-H.csv")
```